# Документация проекта

## Описание микросервисов

### AuthService

`AuthService` отвечает за управление пользователями и сессиями, включая регистрацию, аутентификацию и проверку токенов. Этот микросервис использует базу данных `authdb` для хранения данных пользователей и сессий.

- **Основные компоненты**:
  - `User`: сущность пользователя.
  - `Session`: сущность сессии, хранящая информацию о текущих сессиях пользователей.
  - `AuthController`: контроллер, обрабатывающий запросы на регистрацию и логин.
  - `UserService`: сервис, отвечающий за логику работы с пользователями.
  - `SessionService`: сервис, отвечающий за логику работы с сессиями.
  - `JwtUtil`: утилита для работы с JWT токенами.

#### Основные функции:

- **Регистрация пользователей**: Создание нового пользователя с уникальным ником и адресом электронной почты.
- **Аутентификация пользователей**: Проверка учетных данных пользователя и создание сессии с JWT токеном.
- **Проверка токенов**: Валидация JWT токенов, проверка их актуальности и действительности.

#### Спецификация API:

[![Run in Postman](https://run.pstmn.io/button.svg)](https://app.getpostman.com/join-team?invite_code=21bc3d17a70100336942cfe37bca74c9&target_code=715729fe9faef29cf49fa02c49b33f7c)

1. **Регистрация пользователя**
    - **URL**: `/api/register`
    - **Метод**: `POST`
    - **Тело запроса**:
        ```json
        {
          "nickname": "testuser",
          "email": "testuser@example.com",
          "password": "Test@1234"
        }
        ```
    - **Ответ**: `201 Created` при успешной регистрации.

2. **Вход пользователя**
    - **URL**: `/api/login`
    - **Метод**: `POST`
    - **Тело запроса**:
        ```json
        {
          "email": "testuser@example.com",
          "password": "qwerty12345"
        }
        ```
    - **Ответ**: `200 OK`
        ```json
        {
          "token": "jwt-token"
        }
        ```

3. **Проверка токена**
    - **URL**: `/api/validate`
    - **Метод**: `GET`
    - **Параметры запроса**: `token`: JWT токен
    - **Ответ**: `200 OK`
        ```json
        {
          "valid": true
        }
        ```

4. **Получение информации о пользователе**
    - **URL**: `/api/user`
    - **Метод**: `GET`
    - **Заголовки**: `Authorization`: `Bearer jwt-token`
    - **Ответ**: `200 OK`
        ```json
        {
          "id": 1,
          "nickname": "testuser",
          "email": "testuser@example.com",
          "created": "2024-06-11T10:41:49"
        }
        ```

### OrderService

`OrderService` управляет заказами на покупку билетов, включая создание и обработку заказов. Этот микросервис использует базу данных `orderdb` для хранения данных о заказах и станциях.

- **Основные компоненты**:
  - `Order`: сущность заказа.
  - `Station`: сущность станции, используемой для заказа.
  - `OrderController`: контроллер, обрабатывающий запросы на создание и получение заказов.
  - `OrderService`: сервис, отвечающий за логику работы с заказами.
  - `StationService`: сервис, отвечающий за логику работы со станциями.

#### Основные функции:

- **Создание заказов**: Позволяет авторизованным пользователям создавать заказы на покупку билетов.
- **Обработка заказов**: Проверка статусов заказов и изменение их статусов с небольшой задержкой.
- **Получение информации о заказах**: Возвращает информацию о заказе по его идентификатору.
- **Управление станциями**: Возвращает информацию о станциях и их идентификаторах.

#### Спецификация API:

[![Run in Postman](https://run.pstmn.io/button.svg)](https://app.getpostman.com/join-team?invite_code=21bc3d17a70100336942cfe37bca74c9&target_code=715729fe9faef29cf49fa02c49b33f7c)

1. **Создание заказа**
    - **URL**: `/api/orders`
    - **Метод**: `POST`
    - **Заголовки**: `Authorization`: `Bearer jwt-token`
    - **Тело запроса**:
        ```json
        {
          "userId": 1,
          "fromStation": { "id": 1 },
          "toStation": { "id": 2 },
          "status": 1
        }
        ```
    - **Ответ**: `201 Created`
        ```json
        {
          "id": 1,
          "userId": 1,
          "fromStation": { "id": 1, "station": "Station A" },
          "toStation": { "id": 2, "station": "Station B" },
          "status": 1,
          "created": "2024-06-11T11:00:51"
        }
        ```

2. **Получение информации о заказе**
    - **URL**: `/api/orders/{id}`
    - **Метод**: `GET`
    - **Заголовки**: `Authorization`: `Bearer jwt-token`
    - **Ответ**: `200 OK`
        ```json
        {
          "id": 1,
          "userId": 1,
          "fromStation": { "id": 1, "station": "Station A" },
          "toStation": { "id": 2, "station": "Station B" },
          "status": 1,
          "created": "2024-06-11T11:00:51"
        }
        ```

3. **Получение информации о всех станциях**
    - **URL**: `/api/stations`
    - **Метод**: `GET`
    - **Ответ**: `200 OK`
        ```json
        [
          { "id": 1, "station": "Station A" },
          { "id": 2, "station": "Station B" }
        ]
        ```

4. **Получение информации о станции**
    - **URL**: `/api/stations/{id}`
    - **Метод**: `GET`
    - **Ответ**: `200 OK`
        ```json
        {
          "id": 1,
          "station": "Station A"
        }
        ```

## Взаимодействие компонентов

- Клиентское приложение взаимодействует с AuthService для регистрации и аутентификации пользователей.
- AuthService генерирует JWT токены, которые клиент использует для авторизации запросов к OrderService.
- OrderService проверяет JWT токены через AuthService перед выполнением операций.

## Использованные технологии

### Языки программирования

- **Java**: Основной язык программирования для разработки микросервисов.

### Фреймворки и библиотеки

- **Spring Boot**: Для создания микросервисов.
- **Spring Security**: Для обеспечения безопасности и авторизации.
- **Spring Data JPA**: Для работы с базами данных через ORM.
- **Spring Web**: Для создания RESTful API.
- **Jakarta Validation**: Для валидации данных.
- **Jakarta Persistence**: Для работы с персистентными данными.
- **Jackson**: Для сериализации и десериализации JSON данных.
- **JWT (JSON Web Token)**: Для создания и проверки токенов авторизации.
- **Hibernate**: Для работы с базой данных через ORM.

### Базы данных

- **PostgreSQL**: Для хранения данных пользователей, сессий, заказов и станций.

### Инструменты

- **Docker**: Для контейнеризации микросервисов и баз данных.
- **Docker Compose**: Для оркестрации контейнеров Docker.
- **PgAdmin**: Для управления базами данных PostgreSQL через веб-интерфейс.

### Прочие технологии

- **RestTemplate**: Для взаимодействия между микросервисами через HTTP-запросы.
- **Maven**: Для управления зависимостями и сборки проекта.

## Запуск проекта

### Шаги для запуска

1. Установить Docker и Docker Compose.
2. Склонировать репозиторий проекта.
3. Перейти в корневую папку проекта и выполнить команду:
    ```bash
    docker-compose up
    ```
4. pgAdmin: http://localhost:8081 (email: admin@example.com, password: admin)
5. Добавьте сервер OrderDB (Host name/address: orderdb ; port: 5432 ; user: postgres ; password: postgres). Аналогично, можно добавить сервер AuthDB при необходимости.
6. Необходимо заполнить таблицу stations в OrderDB:
    ```bash
    INSERT INTO stations (id, station) VALUES 
    (1, 'Station A'),
    (2, 'Station B'),
    (3, 'Station C'),
    (4, 'Station D'),
    (5, 'Station E');
    ```
Эта команда поднимет все необходимые сервисы, базы данных и микросервисы, и они будут доступны по соответствующим портам.
